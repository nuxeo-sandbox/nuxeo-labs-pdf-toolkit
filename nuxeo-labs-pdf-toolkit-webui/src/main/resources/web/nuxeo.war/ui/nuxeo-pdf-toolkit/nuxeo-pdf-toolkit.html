<!--
`nuxeo-pdf-toolkit`
Displays a dialog allowing to extract, remove or reorder pages of a PDF document.
-->
<link rel="import" href="nuxeo-pdf-toolkit-thumbnails.html">
<link rel="import" href="nuxeo-pdf-toolkit-preview.html">
<link rel="import" href="nuxeo-pdf-toolkit-actions.html">
<dom-module id="nuxeo-pdf-toolkit">
  <template>
    <style include="nuxeo-styles nuxeo-action-button-styles">
      :host {
        display: inline-block;
      }

      #dialog {
        width: 80%;
        /*max-width: 900px;*/
        height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .dialog-header {
        padding: 16px 24px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 20px;
        font-weight: 500;
      }

      .dialog-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
      }

      .dialog-actions {
        padding: 16px 24px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
        margin-bottom: 5px;
      }


      /* "running operation"" overlay styles */
      .runningOperation-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .runningOperation-message {
        margin-top: 16px;
        font-size: 14px;
        color: var(--nuxeo-text-default, #666);
        text-align: center;
      }

      paper-spinner {
        --paper-spinner-layer-1-color: var(--nuxeo-primary-color, #0066cc);
        --paper-spinner-layer-2-color: var(--nuxeo-primary-color, #0066cc);
        --paper-spinner-layer-3-color: var(--nuxeo-primary-color, #0066cc);
        --paper-spinner-layer-4-color: var(--nuxeo-primary-color, #0066cc);
      }
    </style>

    <nuxeo-operation id="extractOp" op="PDFLabs.ExtractPagesByRange"></nuxeo-operation>
    <nuxeo-operation id="removePagesOp" op="PDFLabs.RemovePages"></nuxeo-operation>
    <nuxeo-operation id="reorderOp" op="PDFLabs.ReorderPages"></nuxeo-operation>

    <nuxeo-operation id="getThumbnailsOp" op="PDFLabs.GetThumbnails"></nuxeo-operation>

    <div class="action" on-tap="_openDialog">
      <paper-icon-button id="bt" icon="[[icon]]"></paper-icon-button>
      <span class="label" hidden$="[[!showLabel]]">[[i18n(label)]]</span>
    </div>
    <paper-tooltip for="bt">[[i18n(label)]]</paper-tooltip>

    <paper-dialog id="dialog" modal>
      <div class="dialog-header">
        [[document.title]]
      </div>
      
      <div class="dialog-content">
        <!-- Running operation indicator -->
        <template is="dom-if" if="[[_runningOperation]]">
          <div class="runningOperation-overlay">
            <paper-spinner active></paper-spinner>
            <div class="runningOperation-message">[[_getRunningOperationMessage()]]</div>
          </div>
        </template>

        <nuxeo-pdf-toolkit-thumbnails
          id="thumbnails"
          sources="[[thumbnailSources]]"
          loading="[[loading]]"
          has-selection="{{_hasSelection}}"
          has-reordered="{{_hasReordered}}"
          on-page-preview="_onPagePreview">
        </nuxeo-pdf-toolkit-thumbnails>
      </div>

      <div class="dialog-actions">
        <nuxeo-pdf-toolkit-actions
          document="[[document]]"
          has-selection="[[_hasSelection]]"
          has-reordered="[[_hasReordered]]"
          on-action-complete="_onActionComplete">
        </nuxeo-pdf-toolkit-actions>
        <paper-button on-tap="_closeDialog">
          <iron-icon icon="icons:close"></iron-icon>
          [[i18n('pdftoolkit.label.close')]]
        </paper-button>
      </div>
    </paper-dialog>
    
    <nuxeo-pdf-toolkit-preview id="preview"></nuxeo-pdf-toolkit-preview>

  </template>

  <script>
    Polymer({
      is: 'nuxeo-pdf-toolkit',
      behaviors: [Nuxeo.LayoutBehavior],

      properties: {
        document: {
          type: Object,
          observer: '_documentChanged'
        },

        icon: {
          type: String,
          value: 'icons:build'
        },

        label: {
          type: String,
          value: 'PDF Toolkit'
        },

        showLabel: {
          type: Boolean,
          value: false
        },

        thumbnailSources: {
          type: Array,
          value: function() { return []; }
        },

        loading: {
          type: Boolean,
          value: false
        },

        _hasSelection: {
          type: Boolean,
          value: false
        },

        _hasReordered: {
          type: Boolean,
          value: false
        },

        _runningOperation: {
          type: Boolean,
          value: false
        },

        _operationStartTime: {
          type: Number,
          value: 0
        },

        _hideOverlayTimer: {
          type: Number,
          value: 0
        }

      },

      // ==============================================
      // Lifecycle & dialog logic
      // ==============================================
      _documentChanged: function() {
        this.set('thumbnailSources', []);
        if (this.$.thumbnails) {
          this.$.thumbnails.reset();
        }
      },

      _openDialog: function() {
        if (!this.document) {
          return;
        }
        this.$.dialog.open();
        this._loadThumbnails();
      },

      _closeDialog: function() {
        this.$.dialog.close();
        this.fire('document-updated');
      },

      // ==============================================
      // UI events from children
      // ==============================================
      _onPagePreview: function(e) {
        this.$.preview.loadPreviewPage(this.document, e.detail.pageNum);
      },

      _onActionComplete: function(e) {
        /* Event fired from nuxeo-pdf-toolkit-actions when user confirms destination
           The JSON sent is:
            {
              action: extract|remove|reorder,
              destination: download|derivative|attachments|newFile,
          // plus other params depending on destination:
          // for 'newFile': createVersion (boolean), versionType (string)
          // for derivative: resetLifeCycle (boolean), derivativeTitle (string)
          // . . .
            }
        */
        var destinationObj = this._buildDestinationObject(e.detail);

        switch (e.detail.action) {
          case 'extract':
            this._extractPages(destinationObj);
            break;

          case 'remove':
            this._removePages(destinationObj);
            break;

          case 'reorder':
            this._saveReorder(destinationObj);
            break;

          default:
            console.error('Unknown action:', e.detail.action);
        }
      },

      // ==============================================
      // PDF operations
      // ==============================================
      _extractPages: function(destinationObj) {
        var pageRange = this.$.thumbnails.getSelectedPageRanges();
        if (!pageRange) {
          return;
        }

        this._startRunningOperation();

        this.$.extractOp.input = this.document;
        this.$.extractOp.params = {
          pageRange: pageRange,
          destinationJsonStr: JSON.stringify(destinationObj)
        };

        this.$.extractOp.execute()
          .then(function(response) {
            this._handleResult(response, destinationObj.destination);
          }.bind(this))
          .catch(function(error) {
            this._handleOperationError(error);
          }.bind(this));
      },

      _removePages: function(destinationObj) {
        var pageRange = this.$.thumbnails.getSelectedPageRanges();
        if (!pageRange) {
          return;
        }

        if(destinationObj.destination === 'newFile') {
          if (!confirm(this.i18n('pdftoolkit.confirm.removePages'))) {
            return;
          }
        }

        this._startRunningOperation();

        this.$.removePagesOp.input = this.document;
        this.$.removePagesOp.params = {
          pageRange: pageRange,
          destinationJsonStr: JSON.stringify(destinationObj)
        };

        this.$.removePagesOp.execute()
            .then(function(response) {
            this._handleResult(response, destinationObj.destination);
          }.bind(this))
          .catch(function(error) {
            this._handleOperationError(error);
          }.bind(this));
      },

      _saveReorder: function(destinationObj) {
        var newOrder = this.$.thumbnails.getNewPageOrder();
        if (!newOrder || !newOrder.length) {
          return;
        }

        this._startRunningOperation();

        this.$.reorderOp.input = this.document;
        this.$.reorderOp.params = {
          pageOrderJsonStr: JSON.stringify(newOrder),
          destinationJsonStr: JSON.stringify(destinationObj)
        };

        this.$.reorderOp.execute()
          .then(function(response) {
            this._handleResult(response, destinationObj.destination);
          }.bind(this))
          .catch(function(error) {
            this._handleOperationError(error);
          }.bind(this));
      },

      // ==============================================
      // "Running operation" overlay
      // ==============================================
      _startRunningOperation: function() {
        // Cancel any pending hide
        if (this._hideOverlayTimer) {
          clearTimeout(this._hideOverlayTimer);
          this._hideOverlayTimer = 0;
        }
        this._operationStartTime = Date.now();
        this.set('_runningOperation', true);
      },

      _finishRunningOperation: function(callback) {
        var self = this;

        // If nothing is running, just call the callback immediately
        if (!this._runningOperation) {
          if (callback) {
            callback.call(this);
          }
          return;
        }

        var MIN_DURATION = 2000; // 2 seconds
        var now = Date.now();
        var start = this._operationStartTime || now;
        var elapsed = now - start;
        var remaining = MIN_DURATION - elapsed;

        var done = function() {
          self.set('_runningOperation', false);
          self._operationStartTime = 0;
          self._hideOverlayTimer = 0;
          if (callback) {
            callback.call(self);
          }
        };

        if (remaining > 0) {
          this._hideOverlayTimer = setTimeout(done, remaining);
        } else {
          done();
        }
      },

      _handleOperationError: function(error) {
        console.error(error);
        alert('An error occured: ' + error);
        // Hide overlay, but keep the dialog open so the user can try again
        this._finishRunningOperation();
      },

      _handleResult: function(operationResponse, destination) {
        switch (destination) {
          case 'derivative':
          case 'attachments':
          case 'newFile':
            // we could navigate to the new doc here if needed
            break;

          case 'download':
            this._downloadBlob(operationResponse);
            break;
        }

        // We are done with the whole dialog.
        // Ensure overlay stays at least 2 seconds, then close.
        this._finishRunningOperation(function() {
          this._closeDialog();
        }.bind(this));
      },

      // ==============================================
      // Helpers
      // ==============================================
      _loadThumbnails: function() {
        this.set('loading', true);

        var op = this.$.getThumbnailsOp;
        op.input = this.document;
        op.params = {}; // if any
        op.execute()
          .then(function(response) {
            // PDFLabs.GetThumbnails returns base64 images...
            var sources = response.map(function(imgData) {
              return 'data:image/png;base64,' + imgData;
            });
            // ... if it returned an array of URLS, we would just:
            // var sources = response;
            this.set('thumbnailSources', sources);
            this.set('loading', false);
          }.bind(this))
          .catch(function(error) {
            console.error('Failed to load thumbnails', error);
            this.set('loading', false);
          }.bind(this));
      },

      // This functiuon prepares the object to send to the operation(s)
      _buildDestinationObject: function(detail) {
        var destinationObj = {
          destination: detail.destination
        };

        switch (detail.destination) {
          case 'newFile':
            destinationObj.details = {
              createVersion: detail.createVersion
            }
            if(destinationObj.details.createVersion) {
              destinationObj.details.versionType = detail.versionType;
            }
            break;

          case 'derivative':
            destinationObj.details = {
              resetLifeCycle: detail.resetLifeCycle,
              derivativeTitle: detail.derivativeTitle
            }
            break;
        }

        return destinationObj;
      },

      _downloadBlob: function(operationResult) {
        var contentDisposition = operationResult.headers.get('Content-Disposition');
        var filenameMatches = contentDisposition
          .match(/filename[^;=\n]*=([^;\n]*''([^;\n]*)|[^;\n]*)/)
          .filter(function(match) {
            return !!match;
          });
        var filename = decodeURI(filenameMatches[filenameMatches.length - 1]);

        operationResult.blob()
          .then(function(blob) {
            var a = document.createElement('a');
            a.style = 'display: none';
            a.download = filename;
            a.href = URL.createObjectURL(blob);
            a.click();
            URL.revokeObjectURL(a.href);
          });
      }
    });
  </script>
</dom-module>
