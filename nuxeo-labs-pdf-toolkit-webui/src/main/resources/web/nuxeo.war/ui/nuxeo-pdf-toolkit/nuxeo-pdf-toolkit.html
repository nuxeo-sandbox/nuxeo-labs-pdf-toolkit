<!--
`nuxeo-pdf-toolkit`
Displays a dialog allowing to extract, remove or reorder pages of a PDF document.
-->
<link rel="import" href="nuxeo-pdf-toolkit-thumbnails.html">
<link rel="import" href="nuxeo-pdf-toolkit-preview.html">
<dom-module id="nuxeo-pdf-toolkit">
  <template>
    <style include="nuxeo-styles nuxeo-action-button-styles">
      :host {
        display: inline-block;
      }

      #dialog {
        width: 80%;
        /*max-width: 900px;*/
        height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .dialog-header {
        padding: 16px 24px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 20px;
        font-weight: 500;
      }

      .dialog-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
      }

      .dialog-actions {
        padding: 16px 24px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
        margin-bottom: 5px;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      paper-button.primary {
        background-color: var(--nuxeo-primary-color, #0066ff);
        color: white;
      }

      paper-button.danger {
        background-color: #d32f2f;
        color: white;
      }

      paper-button[disabled] {
        background-color: #e0e0e0;
        color: #999;
      }
    </style>

    <nuxeo-operation id="extractOp" op="PDFLabs.ExtractPagesByRange"></nuxeo-operation>
    <nuxeo-operation id="removePagesOp" op="PDFLabs.RemovePages"></nuxeo-operation>
    <nuxeo-operation id="reorderOp" op="PDFLabs.ReorderPages"></nuxeo-operation>

    <nuxeo-operation id="getThumbnailsOp" op="PDFLabs.GetThumbnails"></nuxeo-operation>

    <div class="action" on-tap="_openDialog">
      <paper-icon-button id="bt" icon="[[icon]]"></paper-icon-button>
      <span class="label" hidden$="[[!showLabel]]">[[i18n(label)]]</span>
    </div>
    <paper-tooltip for="bt">[[i18n(label)]]</paper-tooltip>

    <paper-dialog id="dialog" modal>
      <div class="dialog-header">
        [[document.title]]
      </div>

      <div class="dialog-content">
        <nuxeo-pdf-toolkit-thumbnails
          id="thumbnails"
          sources="[[thumbnailSources]]"
          loading="[[loading]]"
          has-selection="{{_hasSelection}}"
          has-reordered="{{_hasReordered}}"
          on-page-preview="_onPagePreview">
        </nuxeo-pdf-toolkit-thumbnails>
      </div>

      <div class="dialog-actions">
        <div class="action-buttons">
          <paper-button class="primary" on-tap="_extractPages" disabled="[[!_hasSelection]]">
            <iron-icon icon="icons:content-copy"></iron-icon>
            [[i18n('pdftoolkit.label.extract')]]
          </paper-button>
          <paper-button class="danger" on-tap="_removePages" disabled="[[!_hasSelection]]">
            <iron-icon icon="icons:delete"></iron-icon>
            [[i18n('pdftoolkit.label.remove')]]
          </paper-button>
          <paper-button class="primary" on-tap="_saveReorder" disabled="[[!_hasReordered]]">
            <iron-icon icon="icons:save"></iron-icon>
            [[i18n('pdftoolkit.label.reorg')]]
          </paper-button>
        </div>
        <paper-button on-tap="_closeDialog">
          <iron-icon icon="icons:close"></iron-icon>
          [[i18n('pdftoolkit.label.close')]]
        </paper-button>
      </div>
    </paper-dialog>
    
    <nuxeo-pdf-toolkit-preview id="preview" document="[[document]]" page="[[_previewPageNum]]"></nuxeo-pdf-toolkit-preview>

  </template>

  <script>
    Polymer({
      is: 'nuxeo-pdf-toolkit',
      behaviors: [Nuxeo.LayoutBehavior],

      properties: {
        document: {
          type: Object,
          observer: '_documentChanged'
        },

        icon: {
          type: String,
          value: 'icons:build'
        },

        label: {
          type: String,
          value: 'PDF Toolkit'
        },

        showLabel: {
          type: Boolean,
          value: false
        },

        thumbnailSources: {
          type: Array,
          value: function() { return []; }
        },

        loading: {
          type: Boolean,
          value: false
        },

        _hasSelection: {
          type: Boolean,
          value: false
        },

        _hasReordered: {
          type: Boolean,
          value: false
        },

        _previewPageNum: {
          type: Number,
          value: null,
          notify: true
        }
      },

      _documentChanged: function() {
        this.set('thumbnailSources', []);
        if (this.$.thumbnails) {
          this.$.thumbnails.reset();
        }
      },

      _loadThumbnails: function() {
        this.set('loading', true);

        var op = this.$.getThumbnailsOp;
        op.input = this.document;
        op.params = {}; // if any
        op.execute()
          .then(function(response) {
            // PDFLabs.GetThumbnails returns base64 images...
            var sources = response.map(function(imgData) {
              return 'data:image/png;base64,' + imgData;
            });
            // ... if it returned an array of URLS, we would just:
            // var sources = response;
            this.set('thumbnailSources', sources);
            this.set('loading', false);
          }.bind(this))
          .catch(function(error) {
            this.set('loading', false);
          }.bind(this));
      },

      _openDialog: function() {
        if (!this.document) {
          return;
        }
        this.$.dialog.open();
        this._loadThumbnails();
      },

      _closeDialog: function() {
        this.$.dialog.close();
      },

      _onPagePreview: function(e) {
        this.set('_previewPageNum', e.detail.pageNum);
      },

      _extractPages: function() {
        var pageRange = this.$.thumbnails.getSelectedPageRanges();
        if (!pageRange) {
          return;
        }

        this.$.extractOp.input = this.document;
        this.$.extractOp.params = { pageRange: pageRange };

        this.$.extractOp.execute()
          .then(function(response) {
            this._downloadBlob(response);
          }.bind(this))
          .catch(function(error) {
            alert('An error occured: ' + error);
          }.bind(this));
      },

      _removePages: function() {
        var pageRange = this.$.thumbnails.getSelectedPageRanges();
        if (!pageRange) {
          return;
        }

        if (!confirm('Are you sure you want to remove the selected pages?')) {
          return;
        }

        this.$.removePagesOp.input = this.document;
        this.$.removePagesOp.params = { pageRange: pageRange };

        this.$.removePagesOp.execute()
          .then(function(response) {
            this._downloadBlob(response);
          }.bind(this))
          .catch(function(error) {
            alert('An error occured: ' + error);
          }.bind(this));
      },

      _saveReorder: function() {
        var newOrder = this.$.thumbnails.getNewPageOrder();
        if (!newOrder || !newOrder.length) {
          return;
        }

        this.$.reorderOp.input = this.document;
        this.$.reorderOp.params = {
          pageOrderJsonStr: JSON.stringify(newOrder)
        };

        this.$.reorderOp.execute()
          .then(function(response) {
            this._downloadBlob(response);
          }.bind(this))
          .catch(function(error) {
            alert('An error occured: ' + error);
          }.bind(this));
      },

      _downloadBlob: function(operationResult) {
        var contentDisposition = operationResult.headers.get('Content-Disposition');
        var filenameMatches = contentDisposition
          .match(/filename[^;=\n]*=([^;\n]*''([^;\n]*)|[^;\n]*)/)
          .filter(function(match) {
            return !!match;
          });
        var filename = decodeURI(filenameMatches[filenameMatches.length - 1]);

        operationResult.blob()
          .then(function(blob) {
            var a = document.createElement('a');
            a.style = 'display: none';
            a.download = filename;
            a.href = URL.createObjectURL(blob);
            a.click();
            URL.revokeObjectURL(a.href);
          });
      }
    });
  </script>
</dom-module>
